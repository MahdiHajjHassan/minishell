#!/usr/bin/env bash
set -euo pipefail

p=./philo

echo "Case: ./philo 1 200 200 200"
$p 1 200 200 200 | sed -n '1,2p'
echo

echo "Case: ./philo 2 800 200 200 (no-death 5s)"
# timeout returns 124 on timeout (which is what we want for no-death)
if timeout 5s $p 2 800 200 200 >/dev/null; then echo FAIL; else echo OK; fi
echo

echo "Case: ./philo 5 800 200 200 (no-death 5s)"
if timeout 5s $p 5 800 200 200 >/dev/null; then echo FAIL; else echo OK; fi
echo

echo "Case: ./philo 5 800 200 200 7 (must_eat)"
out=$($p 5 800 200 200 7)
awk '$3=="is"&&$4=="eating"{eat[$2]++} END{ok=1;for(i=1;i<=5;i++) if(eat[i]<7) ok=0; print (ok?"OK":"FAIL")}' <<<"$out"
echo

echo "Case: ./philo 4 410 200 200 (no-death 5s)"
if timeout 5s $p 4 410 200 200 >/dev/null; then echo FAIL; else echo OK; fi
echo

echo "Case: ./philo 4 310 200 200 (death)"
if $p 4 310 200 200 | grep -m1 -q 'died'; then echo OK; else echo FAIL; fi
echo

echo "Case: ./philo 4 500 200 1.2 (invalid)"
if $p 4 500 200 1.2 >/dev/null 2>&1; then echo FAIL; else echo INVALID; fi
echo

echo "Case: ./philo 4 0 200 200 (invalid)"
if $p 4 0 200 200 >/dev/null 2>&1; then echo FAIL; else echo INVALID; fi
echo

echo "Case: ./philo 4 -500 200 200 (invalid)"
if $p 4 -500 200 200 >/dev/null 2>&1; then echo FAIL; else echo INVALID; fi
echo

echo "Case: ./philo 4 500 200 2147483647 (death after ~500ms)"
$p 4 500 200 2147483647 | grep -m1 'died'
echo

echo "Case: ./philo 4 2147483647 200 200 (short run no-death)"
if timeout 2s $p 4 2147483647 200 200 >/dev/null; then echo FAIL; else echo OK; fi
echo

echo "Case: ./philo 4 214748364732 200 200 (invalid)"
if $p 4 214748364732 200 200 >/dev/null 2>&1; then echo FAIL; else echo INVALID; fi
echo

echo "Case: ./philo 4 200 210 200 (death before 210ms)"
ts=$($p 4 200 210 200 | grep -m1 'died' | awk '{print $1}')
echo "death ts=$ts"
if [[ -n "$ts" && $ts -le 210 ]]; then echo OK; else echo FAIL; fi
echo

echo "Case: ./philo 5 800 200 150 (no-death 5s)"
if timeout 5s $p 5 800 200 150 >/dev/null; then echo FAIL; else echo OK; fi
echo
